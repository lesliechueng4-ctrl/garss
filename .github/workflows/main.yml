name: Auto Build and Update

on:
  # 定时触发：北京时间每天早上 06:00 (UTC 22:00)
  schedule:
    - cron: '0 22 * * *'
  
  # 手动触发：允许你在 Actions 页面手动点击运行，方便测试
  workflow_dispatch:
  
  # 代码推送触发：当 main 分支有代码更新时触发
  push:
    branches:
      - main

# 赋予写入权限，以便能将生成的 README 或 docs 推送回仓库
permissions:
  contents: write

jobs:
  build-and-push:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          # 开启 pipenv 缓存，加快运行速度
          cache: 'pipenv'

      - name: Install Pipenv
        run: pip3 install --user pipenv

      - name: Install Dependencies
        run: pipenv --python python3 && pipenv install

      - name: Run Build Script
        # 这里引用了仓库设置里的 Secrets
        env:
          USER: ${{ secrets.USER }}
          PASSWORD: ${{ secrets.PASSWORD }}
          HOST: ${{ secrets.HOST }}
        # 注意：这里假设你的 Pipfile 中定义了一个名为 'build' 的脚本
        run: pipenv run build

      - name: Commit and Push changes
        run: |
          # 配置 Git 身份为 GitHub Actions 机器人 (比写死个人邮箱更通用)
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # 添加文件
          git add README.md
          git add docs
          
          # 检测是否有文件变动
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto update via GitHub Actions"
            git push
          fi
